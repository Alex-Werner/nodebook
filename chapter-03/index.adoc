:nodeVersion: v0.10
:nodeNextVersion: v0.12
:es: ECMAScript 5
:esNext: ECMAScript 6
:sourceDir: ../../examples/nodebook.chapter-03/src
:revisionYear: 2014

== [ChapitreNumero]#3# Mon premier projet Node.js

Maintenant que nous en savons davantage sur Node en théorie et en pratique, il est temps de plonger dans un vrai projet : plusieurs fichiers, plusieurs dépendances et des tests.

Ce chapitre se focalise sur la conception d'une application système modulaire et robuste.
Nous apprendrons à réaliser nos premiers tests unitaires et à laisser la porte ouverte à l'intégration de cette application avec d'autres programmes.

====
.Sommaire
- Initialiser un projet
- Choisir, installer et gérer des dépendances
- Organiser son code de manière modulaire
- Tester son code
- Design patterns
====

Node excelle dans l'accès aux données et à leur redistribution.
À ce titre, nous allons développer une application qui permet de collecter les données du budget de la ville de Bordeaux.
Ces données sont mises à disposition sous licence libre au format Excel sur le portail Open Data de la ville [URL]#http://opendata.bordeaux.fr/#.

Une fois les données récupérées, nous voudrions éviter de nous retrouver coincé : nous allons permettre la distribution des données vers un autre programme mais aussi vers une API HTTP qui pourrait stocker les données pour une utilisation ultérieure.

Cet exemple d'application vous permettra de couvrir l'essentiel de ce qu'il faut savoir pour créer une application système sans pour autant se fermer les portes.

=== Initialisation du projet

L'initialisation d'un projet est une étape incontournable de tout projet Node, quelle que soit sa taille : petit ou grand, application ou module, public ou privé.

Elle se caractérise principalement par le choix des modules externes à utiliser et de ce fait, par la rédaction du fichier `package.json`.

==== package.json

La création du fichier `package.json` est un élément incontournable de tout projet Node.
Il se situe à la racine d'un module et contient plusieurs catégories d'informations :

- *textuels* : titre, descriptions, liens et licence ;
- *version* : une chaîne respectant le fonctionnement de _node-semver_ ([URL]#https://github.com/isaacs/node-semver#) ;
- *dépendances* : emplacement du module principal et liste explicite de modules nécessaires au bon fonctionnement du projet ;
- *actions* : commandes à exécuter lors des différentes étapes du cycle de vie du projet ;
- *divers* : données de configuration ou utilisées par des modules Node.

.Exemple minimaliste d'un fichier `package.json`
image::{indir}/images/package-json.png[align="center",scaledwidth="85%"]

Le fichier `package.json` est un mécanisme de description, d'installation et de documentation distribué avec les sources de tout projet.
Il joue clairement un rôle essentiel dans la facilité de distribution des modules.
En une ligne de commande, le module est prêt à être utilisé, testé et déployé.

[TIP]
.[RemarquePreTitre]#Commande# npm help json
====
Le détail de chaque clé de configuration est expliqué _via_ cette commande.
Des exemples vous permettront également de mieux comprendre leur utilité.
====

==== npm init

Heureusement nous n'avons pas besoin de connaître la syntaxe exacte du fichier pour débuter.
Nous disposons en effet d'un moyen plus intuitif : la commande `npm init`.
Elle entame une séquence de questions et de réponses – pré-remplies pour la plupart – à l'issu de laquelle un `package.json` sera créé dans le répertoire courant.

Prenez l'habitude de débuter un projet par cette commande, cela vous épargnera temps et erreurs.

.Exemple de questions posées lors de la séquence `npm init`
image::{indir}/images/npm-init.png[align="center",scaledwidth="85%"]

==== Ajouter une dépendance externe

Conséquence directe de la présence d'un fichier `package.json` :  nous pouvons (et voulons) déclarer les dépendances externes dont notre projet a besoin pour fonctionner.

Le module npm `excel-stream` ([URL]#https://npmjs.org/excel-stream#) semble être un bon candidat pour la lecture de fichiers Excel.
Nous pouvons l'installer et le lier à notre projet par le biais de la commande `npm install` :

----
npm install --save excel-stream
----

.Exemple de résultat de la commande `npm install`
image::{indir}/images/npm-install-save.png[align="center",scaledwidth="85%"]

La commande précédente effectue plusieurs opérations :

- elle installe le module `excel-stream` dans le répertoire `node_modules` ;
- elle installe les dépendances nécessaires au fonctionnement du module `excel-stream` ;
- elle inscrit `excel-stream` en tant que dépendance dans notre fichier `package.json`.

.Fichier `package.json` après installation d'une nouvelle dépendance.
image::{indir}/images/npm-install-save-diff.png[align="center",scaledwidth="85%"]

Le programme npm prend soin de créer la section `dependencies` si elle n'existe pas, et y rajoute la clé `excel-stream` associée à un numéro de version, ici `~1.0.8`.
Il s'agit de la notation _semver_ ([URL]#http://semver.org#).

[WARNING]
.semver
====
On parle de semver dans le chapitre 1 – il vaudrait peut-être mieux reporter une partie de l'encadré ici.
====

Il est désormais possible d'invoquer `excel-stream` via la fonction `require` au sein de notre code :

[source,javascript]
----
var excel = require('excel-stream');
----

Maintenant que nous savons installer et sauvegarder des dépendances par le biais du fichier `package.json`, prenons le temps d'initialiser la gestion des versions.

==== Intégration avec Git

Node s'intègre parfaitement avec les gestionnaires de version de code.
Nous illustrerons la démarche à l'aide de Git mais sachez qu'il est tout à fait possible d'utiliser SVN, Team Foundation Server ou un autre gestionnaire de votre choix.

La configuration initiale des fichiers à ignorer est extrêmement réduite.
Un cas minimal de contenu de fichier `.gitignore` tient en trois lignes :

[source]
.gitignore
----
# Code source des dépendances externes
node_modules

# Logs
logs
*.log
----

On se content simplement d'_ignorer le code source des dépendances externes_ et les éventuels fichiers de log générés par le programme npm ou vos futures applications.


----
git init
git add package.json .gitignore
git commit -m "Premier commit"
git remote add origin git@votre-serveur-git:repo.git
git push origin master
----

À ce stade, nous avons non seulement initialisé le projet Node mais il est également 

==== Organiser son espace de travail

=== Tester le code

==== Qualité syntaxique

==== Tests unitaires

=== Design patterns

==== Modules

==== Injection

==== Callbacks

==== Évènements

==== Promesses

==== Héritage prototypal

==== Application partielle

=== Choisir ses modules npm

==== Modules populaires


:nodeVersion: v0.10
:nodeNextVersion: v0.12
:es: ECMAScript 5
:esNext: ECMAScript 6
:sourceDir: ../../examples/nodebook.chapter-03/src
:revisionYear: 2014

== [ChapitreNumero]#3# Premier projet

Maintenant que nous en savons davantage sur Node en théorie et en pratique, il est temps de plonger dans quelque chose de plus ambitieux : la gestion d'un projet entier.

Ce chapitre se focalise sur les différentes étapes d'un projet Node, de son initialisation jusqu'à son exécution sur votre poste de travail en passant par l'installation et la vérification de dépendances npm.

====
.Sommaire
- Organiser son espace de travail
- Gérer les différentes étapes du cycle de vie d'un projet Node
- Connaître et choisir des dépendances npm
- Design pattern
====


=== Cycles de vie d'un projet

La création du fichier `package.json` est un élément incontournable de tout projet Node.
Il se situe à la racine d'un module et contient plusieurs catégories d'informations :

- *textuels* : titre, descriptions, liens et licence ;
- *version* : une chaîne respectant le fonctionnement de _node-semver_ ([URL]#https://github.com/isaacs/node-semver#) ;
- *dépendances* : emplacement du module principal et liste explicite de modules nécessaires au bon fonctionnement du projet ;
- *actions* : commandes à exécuter lors des différentes étapes du cycle de vie du projet ;
- *divers* : données de configuration ou utilisées par des modules Node.

.Exemple minimaliste d'un fichier `package.json`
image::{indir}/images/package-json.png[align="center",scaledwidth="85%"]

Le fichier `package.json` est un mécanisme de description, d'installation et de documentation distribué avec les sources de tout projet.
Il joue clairement un rôle essentiel dans la facilité de distribution des modules.
En une ligne de commande, le module est prêt à être utilisé, testé et déployé.

==== Initialisation

L'initialisation d'un projet est une étape incontournable de tout projet Node, quelle que soit sa taille : petit ou grand, application ou module, public ou privé.

Elle se caractérise principalement par le choix des modules externes à utiliser et de ce fait, par la rédaction du fichier `package.json`.

===== npm init

Heureusement nous n'avons pas besoin de connaître la syntaxe exacte du fichier pour débuter.
Nous disposons en effet d'un moyen plus intuitif : la commande `npm init`.
Elle entame une séquence de questions et de réponses – pré-remplies pour la plupart – à l'issu de laquelle un `package.json` sera créé dans le répertoire courant.

Prenez l'habitude de débuter un projet par cette commande, cela vous épargnera temps et erreurs.

.Exemple de questions posées lors de la séquence `npm init`
image::{indir}/images/npm-init.png[align="center",scaledwidth="85%"]

[TIP]
.[RemarquePreTitre]#Commande# npm help json
====
Le détail de chaque clé de configuration est expliqué _via_ cette commande.
Des exemples vous permettront également de mieux comprendre leur utilité.
====

===== Organisation de l'espace de travail

===== Ajouter des dépendances

Conséquence directe de la présence d'un fichier `package.json` :  nous pouvons (et voulons) déclarer les dépendances externes dont notre projet a besoin pour fonctionner.

Le module npm `excel-stream` ([URL]#https://npmjs.org/excel-stream#) semble être un bon candidat pour la lecture de fichiers Excel.
Nous pouvons l'installer et le lier à notre projet par le biais de la commande `npm install` :

----
npm install --save excel-stream
----

.Exemple de résultat de la commande `npm install`
image::{indir}/images/npm-install-save.png[align="center",scaledwidth="85%"]

La commande précédente effectue plusieurs opérations :

- elle installe le module `excel-stream` dans le répertoire `node_modules` ;
- elle installe les dépendances nécessaires au fonctionnement du module `excel-stream` ;
- elle inscrit `excel-stream` en tant que dépendance dans notre fichier `package.json`.

.Fichier `package.json` après installation d'une nouvelle dépendance.
image::{indir}/images/npm-install-save-diff.png[align="center",scaledwidth="85%"]

Le programme npm prend soin de créer la section `dependencies` si elle n'existe pas, et y rajoute la clé `excel-stream` associée à un numéro de version, ici `~1.0.8`.
Il s'agit de la notation _semver_ ([URL]#http://semver.org#).

[WARNING]
.semver
====
On parle de semver dans le chapitre 1 – il vaudrait peut-être mieux reporter une partie de l'encadré ici.
====

Il est désormais possible d'invoquer `excel-stream` via la fonction `require` au sein de notre code :

[source,javascript]
----
var excel = require('excel-stream');
----

Maintenant que nous savons installer et sauvegarder des dépendances par le biais du fichier `package.json`, prenons le temps d'initialiser la gestion des versions.

===== Versionner son code

Node s'intègre parfaitement avec les gestionnaires de version de code.
Nous illustrerons la démarche à l'aide de Git mais sachez qu'il est tout à fait possible d'utiliser SVN, Team Foundation Server ou un autre gestionnaire de votre choix.

La configuration initiale des fichiers à ignorer est extrêmement réduite.
Un cas minimal de contenu de fichier `.gitignore` tient en trois lignes :

[source]
.gitignore
----
# Code source des dépendances externes
node_modules

# Logs
logs
*.log
----

On se content simplement d'_ignorer le code source des dépendances externes_ et les éventuels fichiers de log générés par le programme npm ou vos futures applications.


----
git init
git add package.json .gitignore
git commit -m "Premier commit"
git remote add origin git@votre-serveur-git:repo.git
git push origin master
----

À ce stade, nous avons non seulement initialisé le projet Node mais il est également 

===== Approche modulaire

designer une API et l'exposer 

==== Installation

son code mais aussi les dépendances

===== Locale

- git

===== Globale

- git + npm
- npm -g

==== Configuration

===== package.json

===== Variables d'environnement

===== Fichier de configuration

- fichier json
- package.json + npm start

==== Exécution de l'application

===== Invocation Node

===== npm start

===== Orchestration des services

- plusieurs app Node
- services système
- npm run postinstall

==== Modification de l'application

===== npm test

- simple
- complexe avec variables d'environnement

===== Choisir un bon numéro de version

===== Publication du code

- dans npm
- dans un repo git public (mais pas sur npm)
- dans un repo git privé (et donc pas sur npm)

==== Opérations de routine

===== Vérifier l'état des dépendances

===== Éclater sa base de code

===== Alertes de sécurité

- node
- packages npm

=== Bien utiliser npm

==== Chercher un module

==== Critères de sélection d'un module

==== Sélection de modules utiles et courants

===== Manipulations diverses
===== Base de données
===== Ligne de commande
===== HTTP et API
===== Préprocesseurs
===== Gestion des dates
===== Templating
===== Tests
===== Automatisation de tâches

==== Auteurs et communautés de confiance

=== Design patterns

==== index.js

==== Injection de module

==== Callback

==== Event

==== Promesses

==== Streams

==== Bloquant / non-bloquant / synchrone / asynchrone


